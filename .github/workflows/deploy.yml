name: Deploy to Hetzner

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            # Navigate to the app directory
            # We use the absolute path to be sure, assuming 'riccardo' user
            # or we try to find it in the home directory
            APP_DIR="/home/riccardo/atari-rl-dashboard"
            if [ ! -d "$APP_DIR" ]; then
              APP_DIR="$HOME/atari-rl-dashboard"
            fi
            
            echo "üìÇ Navigating to $APP_DIR..."
            cd "$APP_DIR" || exit 1
            
            echo "üì• Pulling latest changes..."
            git pull origin main
            
            echo "üì¶ Updating dependencies..."
            # Use the venv pip
            ./.venv/bin/pip install -r requirements.txt --quiet
            
            echo "‚öôÔ∏è Restarting service..."
            # Restart the service to pick up changes
            sudo systemctl restart atari
            
            echo "‚ú® Deployment successful!"
            echo "‚úÖ Deployed at $(date)"

